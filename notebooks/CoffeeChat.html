
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>ChatGPT Python Code Writer for Analyzing Datasets &#8212; Coffee Chat - Using ChatGPT to Generate Python Code for Analyzing Your Data (with Coffee)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=4ec06e9971c5264fbd345897d5258098f11cc577" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=8bf782fb4ee92b3d3646425e50f299c4e1fd152d"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/CoffeeChat';</script>
    <link rel="canonical" href="https://holly-transport.github.io/coffee_chat/README.html/notebooks/CoffeeChat.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="🚀 Putting ChatGPT to (Data Science) Work" href="../README.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../README.html">

  
  
  
  
  
  
  

  
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image">
    <img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        ChatGPT Python Code Writer for Analyzing Datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://datapartnership.org">
                        Development Data Partnership
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://wbdatalab.org">
                        World Bank Data Lab
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://www.worldbank.org/en/about/unit/unit-dec">
                        World Bank DEC
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://www.worldbank.org/en/research/dime">
                        World Bank DIME
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        ChatGPT Python Code Writer for Analyzing Datasets
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://datapartnership.org">
                        Development Data Partnership
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://wbdatalab.org">
                        World Bank Data Lab
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://www.worldbank.org/en/about/unit/unit-dec">
                        World Bank DEC
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://www.worldbank.org/en/research/dime">
                        World Bank DIME
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item">
  


<a class="navbar-brand logo" href="../README.html">

  
  
  
  
  
  
  

  
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image">
    <img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    </div>
    <div class="sidebar-start-items__item">
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">How to Use ChatGPT to Write Your Data Science Code (with Coffee)</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">ChatGPT Python Code Writer for Analyzing Datasets</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://datapartnership.org">Development Data Partnership</a></li>
<li class="toctree-l1"><a class="reference external" href="https://wbdatalab.org">World Bank Data Lab</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.worldbank.org/en/about/unit/unit-dec">World Bank DEC</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.worldbank.org/en/research/dime">World Bank DIME</a></li>
</ul>

    </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        <label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" data-toggle="tooltip" data-placement="right" title="Toggle primary sidebar">
            <span class="fa-solid fa-bars"></span>
        </label>
    </div>
    <div class="header-article__right">


<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
  </ul>
</div>

<button onclick="toggleFullScreen()"
  class="btn btn-sm"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<div class="dropdown dropdown-repository-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      <li><a href="https://github.com/Holly-Transport/coffee_chat" target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">repository</span>
</a>
</a>
      
      <li><a href="https://github.com/Holly-Transport/coffee_chat/issues/new?title=Issue%20on%20page%20%2Fnotebooks/CoffeeChat.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">open issue</span>
</a>
</a>
      
      <li><a href="https://github.com/Holly-Transport/coffee_chat/edit/main/notebooks/CoffeeChat.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">suggest edit</span>
</a>
</a>
      
  </ul>
</div>



<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      <li><a href="../_sources/notebooks/CoffeeChat.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</a>
      
      <li>
<button onclick="printPdf(this)"
  class="btn btn-sm dropdown-item"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</a>
      
  </ul>
</div>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary" data-toggle="tooltip" data-placement="left" title="Toggle secondary sidebar">
            <span class="fa-solid fa-list"></span>
        </label>
    </div>
</div>
            </div>
            
            

<div id="jb-print-docs-body" class="onlyprint">
    <h1>ChatGPT Python Code Writer for Analyzing Datasets</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-import-a-lot-of-libraries">
   Step 1: Import (a lot of) libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-2-set-up-your-openai-key">
   Step 2: Set up your OpenAI key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-3-load-your-data-and-parse-inputs-for-the-openai-query">
   Step 3. Load your data and parse inputs for the OpenAI query
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-4-prime-the-ai-define-the-role-and-response-parameters-for-the-ai">
     Step 4. Prime the AI – define the role and response parameters for the AI
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-5-write-a-function-for-sending-base-prompt-and-question-to-openai-and-storing-response">
     Step 5. Write a function for sending base prompt and question to OpenAI and storing response.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-6-ask-a-question">
     Step 6. Ask a question!
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pause">
   Pause!
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-7-parse-the-openai-response-to-pull-out-the-python-code">
   Step 7. Parse the OpenAI response to pull out the Python code.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-8-run-the-code-danger">
   Step 8. Run the code (DANGER!)
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>

            <article class="bd-article" role="main">
              
  <section class="tex2jax_ignore mathjax_ignore" id="chatgpt-python-code-writer-for-analyzing-datasets">
<h1>ChatGPT Python Code Writer for Analyzing Datasets<a class="headerlink" href="#chatgpt-python-code-writer-for-analyzing-datasets" title="Permalink to this heading">#</a></h1>
<p>With examples using Starbucks location data! ☕️</p>
<section id="step-1-import-a-lot-of-libraries">
<h2>Step 1: Import (a lot of) libraries<a class="headerlink" href="#step-1-import-a-lot-of-libraries" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Since we cannot be certain of what kind of code ChatGPT will come up with, </span>
<span class="c1"># we start by installing a bunch of libraries it may use in its response. </span>
<span class="c1"># Lots of these are for making pretty maps. </span>

<span class="c1"># Basics</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">openai</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Mapping</span>
<span class="kn">from</span> <span class="nn">geopy</span> <span class="kn">import</span> <span class="n">distance</span>
<span class="kn">from</span> <span class="nn">geopy.geocoders</span> <span class="kn">import</span> <span class="n">Nominatim</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">geopy.distance</span> <span class="kn">import</span> <span class="n">geodesic</span>
<span class="kn">import</span> <span class="nn">folium</span>

<span class="c1"># Charts</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Parsing text, displaying results in markdown</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">Latex</span>
<span class="kn">import</span> <span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2-set-up-your-openai-key">
<h2>Step 2: Set up your <a class="reference external" href="https://platform.openai.com/">OpenAI key</a><a class="headerlink" href="#step-2-set-up-your-openai-key" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## OPENAI KEY ##</span>
<span class="n">openai</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OPENAI_KEY&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-load-your-data-and-parse-inputs-for-the-openai-query">
<h2>Step 3. Load your data and parse inputs for the OpenAI query<a class="headerlink" href="#step-3-load-your-data-and-parse-inputs-for-the-openai-query" title="Permalink to this heading">#</a></h2>
<p>This sample dataset is a directory of Starbucks locations, scraped from the Starbucks store locator webpage by Github user <a class="reference external" href="https://github.com/chrismeller/">chrismeller</a>. Geospatial coordinates have been truncated, just in case…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in your data (can be multiple datasets)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/directory.csv&#39;</span><span class="p">)</span>

<span class="c1"># Generate a list of columns for each dataset, for later use in generating code</span>
<span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># If you can do it under the API token limit, generate head data for each file, to give the OpenAI API context. </span>
<span class="c1"># Store as a .json so it transmits properly.</span>
<span class="n">head</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">json_head</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

<span class="c1"># Displaying the data head so you have a sense of what&#39;s in it.</span>
<span class="n">display</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0.1</th>
      <th>Unnamed: 0</th>
      <th>Brand</th>
      <th>Store Number</th>
      <th>Store Name</th>
      <th>Ownership Type</th>
      <th>Street Address</th>
      <th>City</th>
      <th>State/Province</th>
      <th>Country</th>
      <th>Postcode</th>
      <th>Phone Number</th>
      <th>Timezone</th>
      <th>Longitude</th>
      <th>Latitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>Starbucks</td>
      <td>47370-257954</td>
      <td>Meritxell, 96</td>
      <td>Licensed</td>
      <td>Av. Meritxell, 96</td>
      <td>Andorra la Vella</td>
      <td>7</td>
      <td>AD</td>
      <td>AD500</td>
      <td>376818720</td>
      <td>GMT+1:00 Europe/Andorra</td>
      <td>1.53</td>
      <td>42.51</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>11</td>
      <td>Starbucks</td>
      <td>1579-122101</td>
      <td>HCT Abu Dhabi Women's College Block</td>
      <td>Licensed</td>
      <td>Najda Street, Higher Colleges of Technology</td>
      <td>Abu Dhabi</td>
      <td>AZ</td>
      <td>AE</td>
      <td>3167</td>
      <td>26426280</td>
      <td>GMT+04:00 Asia/Dubai</td>
      <td>54.37</td>
      <td>24.49</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>12</td>
      <td>Starbucks</td>
      <td>32595-122105</td>
      <td>Standard Chartered Building</td>
      <td>Licensed</td>
      <td>Khalidiya St., Beside Union Cooperative Society</td>
      <td>Abu Dhabi</td>
      <td>AZ</td>
      <td>AE</td>
      <td>3167</td>
      <td>26359275</td>
      <td>GMT+04:00 Asia/Muscat</td>
      <td>55.69</td>
      <td>24.19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>20</td>
      <td>Starbucks</td>
      <td>32767-131566</td>
      <td>Shangri-La Souq</td>
      <td>Licensed</td>
      <td>Shangri-La Souk, Um Al Nar</td>
      <td>Abu Dhabi</td>
      <td>AZ</td>
      <td>AE</td>
      <td>3167</td>
      <td>25581641</td>
      <td>GMT+04:00 Asia/Dubai</td>
      <td>54.51</td>
      <td>24.42</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>45</td>
      <td>Starbucks</td>
      <td>32640-131563</td>
      <td>Tawam Hospital</td>
      <td>Licensed</td>
      <td>Al Ain Abu Dhabi Rd, Khalifa Bin Zayed, Al Mak...</td>
      <td>Al Ain</td>
      <td>AZ</td>
      <td>AE</td>
      <td>3167</td>
      <td>37677581</td>
      <td>GMT+04:00 Asia/Muscat</td>
      <td>55.65</td>
      <td>24.19</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="step-4-prime-the-ai-define-the-role-and-response-parameters-for-the-ai">
<h3>Step 4. Prime the AI – define the role and response parameters for the AI<a class="headerlink" href="#step-4-prime-the-ai-define-the-role-and-response-parameters-for-the-ai" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare your base prompt, which tells the OpenAI oracale what its role is and any</span>
<span class="c1"># information it should use to prepare its response. </span>

<span class="n">BASE_PROMPT</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;You are a python programmer. Write a program that uses the column names&quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">-- from the Starbucks dataframe that can be used to answer the question. If helpful, here&quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;are sample data: </span><span class="si">{</span><span class="n">json_head</span><span class="si">}</span><span class="s2">. The data can be found here: ../data/directory.csv&quot;</span>
     <span class="p">}]</span>

<span class="c1"># Set up global variables so that you can ask follow up questions and receive answers based on prior responses.</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">messages</span> <span class="o">+=</span> <span class="n">BASE_PROMPT</span>
<span class="n">message_response</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-5-write-a-function-for-sending-base-prompt-and-question-to-openai-and-storing-response">
<h3>Step 5. Write a function for sending base prompt and question to OpenAI and storing response.<a class="headerlink" href="#step-5-write-a-function-for-sending-base-prompt-and-question-to-openai-and-storing-response" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">question</span> <span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">messages</span>
    <span class="k">global</span> <span class="n">message_response</span>
    
    <span class="c1"># Add user prompt to messages.</span>
    <span class="n">messages</span> <span class="o">+=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
    
    <span class="c1"># Call the OpenAI API and parse the response.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
    <span class="n">message_response</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
    
    <span class="c1"># Store response for follow up questions. </span>
    <span class="n">messages</span> <span class="o">+=</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span><span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span><span class="n">message_response</span><span class="p">}]</span>

    <span class="c1"># Display the question and results using Markdown</span>
    <span class="n">display</span> <span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">&quot;## &quot;</span> <span class="o">+</span> <span class="n">prompt</span><span class="p">))</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">message_response</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-6-ask-a-question">
<h3>Step 6. Ask a question!<a class="headerlink" href="#step-6-ask-a-question" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;How many Starbucks are in the EU?&quot;</span>
<span class="n">question</span> <span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p class="rubric">How many Starbucks are in the EU?</p>
<p>Here is a code that will answer your question:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Read the Starbucks directory csv file</span>
<span class="n">starbucks_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/directory.csv&#39;</span><span class="p">)</span>

<span class="c1"># Filter the rows with countries in the EU</span>
<span class="n">eu_countries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AT&#39;</span><span class="p">,</span> <span class="s1">&#39;BE&#39;</span><span class="p">,</span> <span class="s1">&#39;BG&#39;</span><span class="p">,</span> <span class="s1">&#39;CY&#39;</span><span class="p">,</span> <span class="s1">&#39;CZ&#39;</span><span class="p">,</span> <span class="s1">&#39;DE&#39;</span><span class="p">,</span> <span class="s1">&#39;DK&#39;</span><span class="p">,</span> <span class="s1">&#39;EE&#39;</span><span class="p">,</span> <span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="s1">&#39;FI&#39;</span><span class="p">,</span> <span class="s1">&#39;FR&#39;</span><span class="p">,</span> <span class="s1">&#39;GR&#39;</span><span class="p">,</span> <span class="s1">&#39;HR&#39;</span><span class="p">,</span> <span class="s1">&#39;HU&#39;</span><span class="p">,</span> <span class="s1">&#39;IE&#39;</span><span class="p">,</span> <span class="s1">&#39;IT&#39;</span><span class="p">,</span> <span class="s1">&#39;LT&#39;</span><span class="p">,</span> <span class="s1">&#39;LU&#39;</span><span class="p">,</span> <span class="s1">&#39;LV&#39;</span><span class="p">,</span> <span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="s1">&#39;NL&#39;</span><span class="p">,</span> <span class="s1">&#39;PL&#39;</span><span class="p">,</span> <span class="s1">&#39;PT&#39;</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">,</span> <span class="s1">&#39;SI&#39;</span><span class="p">,</span> <span class="s1">&#39;SK&#39;</span><span class="p">]</span>
<span class="n">eu_starbucks_df</span> <span class="o">=</span> <span class="n">starbucks_df</span><span class="p">[</span><span class="n">starbucks_df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">eu_countries</span><span class="p">)]</span>

<span class="c1"># Count the number of rows in the filtered dataframe</span>
<span class="n">num_starbucks_in_eu</span> <span class="o">=</span> <span class="n">eu_starbucks_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of Starbucks in the EU:&quot;</span><span class="p">,</span> <span class="n">num_starbucks_in_eu</span><span class="p">)</span>
</pre></div>
</div>
<p>This code reads the Starbucks directory csv file into a pandas dataframe. It then filters the rows with countries in the EU using the <code class="docutils literal notranslate"><span class="pre">isin()</span></code> function to match the ‘Country’ column with the <code class="docutils literal notranslate"><span class="pre">eu_countries</span></code> list. Finally, it counts the number of rows in the filtered dataframe and prints the result.</p>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">Starbucks</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">EU</span><span class="p">:</span> <span class="mi">3194</span>
</pre></div>
</div>
<p>Therefore, there are 3194 Starbucks stores in the EU, based on the provided dataset.</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optional follow up question. You can add these until you run out of tokens. </span>
<span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;Can you turn the response into a chart, using Starbucks-style colors and fonts?&quot;</span>
<span class="n">question</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p class="rubric">Can you turn the response into a chart, using Starbucks-style colors and fonts?</p>
<p>Yes, we can use the <code class="docutils literal notranslate"><span class="pre">seaborn</span></code> library which provides several pre-defined styles such as <code class="docutils literal notranslate"><span class="pre">darkgrid</span></code>, <code class="docutils literal notranslate"><span class="pre">whitegrid</span></code>, <code class="docutils literal notranslate"><span class="pre">dark</span></code>, <code class="docutils literal notranslate"><span class="pre">white</span></code>, <code class="docutils literal notranslate"><span class="pre">ticks</span></code>. Here’s how we can use the <code class="docutils literal notranslate"><span class="pre">seaborn</span></code> library to create the chart with the Starbucks-style colors and fonts.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read the Starbucks directory csv file</span>
<span class="n">starbucks_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/directory.csv&#39;</span><span class="p">)</span>

<span class="c1"># Filter the rows with countries in the EU</span>
<span class="n">eu_countries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AT&#39;</span><span class="p">,</span> <span class="s1">&#39;BE&#39;</span><span class="p">,</span> <span class="s1">&#39;BG&#39;</span><span class="p">,</span> <span class="s1">&#39;CY&#39;</span><span class="p">,</span> <span class="s1">&#39;CZ&#39;</span><span class="p">,</span> <span class="s1">&#39;DE&#39;</span><span class="p">,</span> <span class="s1">&#39;DK&#39;</span><span class="p">,</span> <span class="s1">&#39;EE&#39;</span><span class="p">,</span> <span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="s1">&#39;FI&#39;</span><span class="p">,</span> <span class="s1">&#39;FR&#39;</span><span class="p">,</span> <span class="s1">&#39;GR&#39;</span><span class="p">,</span> <span class="s1">&#39;HR&#39;</span><span class="p">,</span> <span class="s1">&#39;HU&#39;</span><span class="p">,</span> <span class="s1">&#39;IE&#39;</span><span class="p">,</span> <span class="s1">&#39;IT&#39;</span><span class="p">,</span> <span class="s1">&#39;LT&#39;</span><span class="p">,</span> <span class="s1">&#39;LU&#39;</span><span class="p">,</span> <span class="s1">&#39;LV&#39;</span><span class="p">,</span> <span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="s1">&#39;NL&#39;</span><span class="p">,</span> <span class="s1">&#39;PL&#39;</span><span class="p">,</span> <span class="s1">&#39;PT&#39;</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">,</span> <span class="s1">&#39;SI&#39;</span><span class="p">,</span> <span class="s1">&#39;SK&#39;</span><span class="p">]</span>
<span class="n">eu_starbucks_df</span> <span class="o">=</span> <span class="n">starbucks_df</span><span class="p">[</span><span class="n">starbucks_df</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">eu_countries</span><span class="p">)]</span>

<span class="c1"># Count the number of stores in each country in the EU</span>
<span class="n">starbucks_by_country</span> <span class="o">=</span> <span class="n">eu_starbucks_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)[</span><span class="s1">&#39;Brand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Brand&#39;</span><span class="p">:</span> <span class="s1">&#39;Num_Stores&#39;</span><span class="p">})</span>

<span class="c1"># Set Seaborn darkgrid style</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;darkgrid&#39;</span><span class="p">)</span>

<span class="c1"># Create a barplot with the number of Starbucks stores in each country in the EU</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Num_Stores&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">starbucks_by_country</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#00704A&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Number of Starbucks stores in each country in the EU&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of stores&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<p><img alt="Starbucks stores in each EU Country" src="notebooks/starbucks_in_eu.png" /></p>
<p>In this code, we have imported the <code class="docutils literal notranslate"><span class="pre">seaborn</span></code> library to set the style of the chart to “darkgrid”. We have also used a <code class="docutils literal notranslate"><span class="pre">hexadecimal</span> <span class="pre">color</span> <span class="pre">code</span></code> (#00704A) for the color of the bars in the bar plot, which is similar to the color used by Starbucks. Finally, we have customized the chart by setting the title, label, and font size for the x-axis, y-axis, x-ticks, and y-ticks.</p>
<p>Note: Please make sure that you have installed the <code class="docutils literal notranslate"><span class="pre">seaborn</span></code> library to be able to reproduce this code on your system.</p>
</div>
</div>
</section>
</section>
<section id="pause">
<h2>Pause!<a class="headerlink" href="#pause" title="Permalink to this heading">#</a></h2>
<p>Sometimes the response will try to answer the prompt, in addition to providing the code. These answers are often (but not always) nonsense! Make sure you review and run the code yourself to be certain of the result.</p>
<p>Now, here is what is really exciting about OpenAI: the API combines information about the dataset with its own knowledge. For example, when asking about the number of Starbucks in each EU country, the AI will generate a list of countries to use. Or, if asking the AI to use Starbucks colors for charts, it will know to use infamous Starbucks green. 😃 Amazing, and also very risky – always double check the ‘additional knowledge’ being provided.</p>
</section>
<section id="step-7-parse-the-openai-response-to-pull-out-the-python-code">
<h2>Step 7. Parse the OpenAI response to pull out the Python code.<a class="headerlink" href="#step-7-parse-the-openai-response-to-pull-out-the-python-code" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now, we parse the ChatGPT response to pull out the Python code. Full disclosure:</span>
<span class="c1"># I used ChatGPT to write this code, so don&#39;t ask me too many questions about it.</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">message_response</span>

<span class="c1"># Define the regular expression pattern to match the Python code</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;```(?:python)?\n([\s\S]*?)\n```&quot;</span>

<span class="c1"># Extract all Python code blocks from the text</span>
<span class="n">python_blocks</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

<span class="c1"># Combine all Python code blocks into a single string</span>
<span class="n">python_code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">python_blocks</span><span class="p">)</span>

<span class="c1"># Remove import statements from the Python code</span>
<span class="n">python_code</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:from\s+\w+(?:\.\w+)*\s+)?import\s+\w+(\s+as\s+\w+)?(?:,\s*\w+(\s+as\s+\w+)?)*\s*\n&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">python_code</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">python_code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>import matplotlib.pyplot as plt

# Read the Starbucks directory csv file
starbucks_df = pd.read_csv(&#39;../data/directory.csv&#39;)

# Filter the rows with countries in the EU
eu_countries = [&#39;AT&#39;, &#39;BE&#39;, &#39;BG&#39;, &#39;CY&#39;, &#39;CZ&#39;, &#39;DE&#39;, &#39;DK&#39;, &#39;EE&#39;, &#39;ES&#39;, &#39;FI&#39;, &#39;FR&#39;, &#39;GR&#39;, &#39;HR&#39;, &#39;HU&#39;, &#39;IE&#39;, &#39;IT&#39;, &#39;LT&#39;, &#39;LU&#39;, &#39;LV&#39;, &#39;MT&#39;, &#39;NL&#39;, &#39;PL&#39;, &#39;PT&#39;, &#39;RO&#39;, &#39;SE&#39;, &#39;SI&#39;, &#39;SK&#39;]
eu_starbucks_df = starbucks_df[starbucks_df[&#39;Country&#39;].isin(eu_countries)]

# Count the number of stores in each country in the EU
starbucks_by_country = eu_starbucks_df.groupby(&#39;Country&#39;)[&#39;Brand&#39;].count().reset_index().rename(columns={&#39;Brand&#39;: &#39;Num_Stores&#39;})

# Set Seaborn darkgrid style
sns.set_style(&#39;darkgrid&#39;)

# Create a barplot with the number of Starbucks stores in each country in the EU
plt.figure(figsize=(10,7))
sns.barplot(x=&#39;Country&#39;, y=&#39;Num_Stores&#39;, data=starbucks_by_country, color=&#39;#00704A&#39;)
plt.title(&#39;Number of Starbucks stores in each country in the EU&#39;, fontsize=16, fontweight=&#39;bold&#39;)
plt.xlabel(&#39;Country&#39;, fontsize=14, fontweight=&#39;bold&#39;)
plt.ylabel(&#39;Number of stores&#39;, fontsize=14, fontweight=&#39;bold&#39;)
plt.xticks(fontsize=12, fontweight=&#39;bold&#39;)
plt.yticks(fontsize=12, fontweight=&#39;bold&#39;)
plt.show()
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-8-run-the-code-danger">
<h2>Step 8. Run the code (DANGER!)<a class="headerlink" href="#step-8-run-the-code-danger" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following code will execute the OPENAI-generated Python scripts. CHECK THE CODE FIRST!</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">python_code</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FileNotFoundError: directory.csv not found in directory:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0b476bebd72cc5bd44d3bf35788c4b8db5a8e8badeb561fb178527d90b6028d2.png" src="../_images/0b476bebd72cc5bd44d3bf35788c4b8db5a8e8badeb561fb178527d90b6028d2.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

            </article>
            

            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="../README.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">🚀 Putting ChatGPT to (Data Science) Work</p>
      </div>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-import-a-lot-of-libraries">
   Step 1: Import (a lot of) libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-2-set-up-your-openai-key">
   Step 2: Set up your OpenAI key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-3-load-your-data-and-parse-inputs-for-the-openai-query">
   Step 3. Load your data and parse inputs for the OpenAI query
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-4-prime-the-ai-define-the-role-and-response-parameters-for-the-ai">
     Step 4. Prime the AI – define the role and response parameters for the AI
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-5-write-a-function-for-sending-base-prompt-and-question-to-openai-and-storing-response">
     Step 5. Write a function for sending base prompt and question to OpenAI and storing response.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#step-6-ask-a-question">
     Step 6. Ask a question!
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pause">
   Pause!
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-7-parse-the-openai-response-to-pull-out-the-python-code">
   Step 7. Parse the OpenAI response to pull out the Python code.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-8-run-the-code-danger">
   Step 8. Run the code (DANGER!)
  </a>
 </li>
</ul>

</nav>
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Holly Krambeck
</p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    <p class="last-updated">
Last updated on Mar 31, 2023.<br>
</p>
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
    <b>All content (unless otherwise specified) is subject to the <a href="https://raw.githubusercontent.com/worldbank/template/main/LICENSE">World Bank Master Community License Agreement.</a></b>
</div>

</div>
  </div>
  
</div>
          </div>
        </footer>
        

      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  </body>
</html>